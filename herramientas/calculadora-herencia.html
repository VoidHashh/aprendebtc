<!DOCTYPE html>
<html lang="es" data-base-path="../">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Planifica la herencia de tus bitcoin. Calcula la distribucion por herederos y revisa un checklist de seguridad y documentacion." />
  <title>Calculadora de herencia Bitcoin - Herramientas | aprendebtc.com</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="../css/main.css" />
  <link rel="stylesheet" href="../css/components.css" />
  <link rel="stylesheet" href="../css/tools.css" />
</head>
<body>
  <div data-include="header"></div>

  <div class="page-layout">
    <aside class="page-layout__sidebar" aria-label="Navegacion lateral">
      <nav class="sidebar">
        <div class="sidebar__ad-wrap">
          <div class="ad-slot ad-sidebar" id="ad-sidebar-global" aria-hidden="true"></div>
        </div>
      </nav>
    </aside>

    <main class="page-layout__content" id="main-content">
      <div class="content-inner">
        <nav class="breadcrumb" aria-label="Ruta de navegacion">
          <a href="../" class="breadcrumb__item">Inicio</a>
          <span class="breadcrumb__separator" aria-hidden="true">&rsaquo;</span>
          <a href="index.html" class="breadcrumb__item">Herramientas</a>
          <span class="breadcrumb__separator" aria-hidden="true">&rsaquo;</span>
          <span class="breadcrumb__current">Calculadora de herencia</span>
        </nav>

        <article class="article">
          <h1>Calculadora de herencia Bitcoin</h1>
          <p class="article__subtitle">Planifica una distribucion clara para que tus bitcoin lleguen a tus herederos.</p>

          <div class="tool-container">
            <h2 class="tool-container__title">1. Patrimonio Bitcoin</h2>

            <div class="tool-row">
              <div class="tool-field">
                <label class="tool-label" for="btc-holdings">Cantidad de BTC</label>
                <input type="number" id="btc-holdings" class="tool-input" placeholder="Ej: 0,50" min="0" step="0.00000001" />
              </div>
              <div class="tool-field">
                <label class="tool-label">Valor estimado</label>
                <div class="tool-output" id="btc-value-eur">- EUR</div>
              </div>
            </div>

            <div class="tool-price-ticker tool-price-ticker--tight">
              <span class="tool-price-ticker__dot" id="price-dot"></span>
              <span class="tool-price-ticker__text" id="price-ticker-text">Cargando precio...</span>
            </div>
          </div>

          <div class="tool-container">
            <h2 class="tool-container__title">2. Esquema de custodia</h2>

            <div class="custody-diagram" id="custody-options">
              <button type="button" class="custody-option" data-custody="single">
                <span class="custody-option__icon">K1</span>
                <span class="custody-option__title">Single key</span>
                <span class="custody-option__desc">Una seed phrase</span>
              </button>

              <button type="button" class="custody-option" data-custody="multisig-2-3">
                <span class="custody-option__icon">M23</span>
                <span class="custody-option__title">Multisig 2-de-3</span>
                <span class="custody-option__desc">2 firmas de 3</span>
              </button>

              <button type="button" class="custody-option" data-custody="multisig-3-5">
                <span class="custody-option__icon">M35</span>
                <span class="custody-option__title">Multisig 3-de-5</span>
                <span class="custody-option__desc">3 firmas de 5</span>
              </button>

              <button type="button" class="custody-option" data-custody="exchange">
                <span class="custody-option__icon">EX</span>
                <span class="custody-option__title">Custodia en exchange</span>
                <span class="custody-option__desc">Tercero con control</span>
              </button>
            </div>

            <div class="custody-info" id="custody-info" hidden>
              <div class="custody-info__title" id="custody-info-title"></div>
              <ul class="custody-info__risks" id="custody-info-risks"></ul>
            </div>
          </div>

          <div class="tool-container">
            <h2 class="tool-container__title">3. Distribucion por herederos</h2>

            <div id="heirs-container"></div>

            <button class="tool-btn tool-btn--secondary" id="add-heir-btn" type="button">Anadir heredero</button>

            <div class="percentage-total" id="percentage-total">
              <span>Total asignado:</span>
              <span id="percentage-sum">0%</span>
            </div>

            <div class="heir-results" id="heir-results" hidden>
              <h3 class="heir-results__title">Distribucion calculada</h3>
              <div id="heir-results-list"></div>
            </div>
          </div>

          <div class="tool-container">
            <h2 class="tool-container__title">4. Checklist</h2>
            <p class="tool-note">Marca lo que ya has dejado resuelto para reducir riesgo operativo.</p>

            <ul class="tool-checklist" id="checklist"></ul>

            <div class="tool-btn-row tool-btn-row--tight">
              <button class="tool-btn" id="export-plan-btn" type="button">Descargar plan</button>
            </div>
          </div>

          <div class="tool-disclaimer">
            <strong>Aviso:</strong> Esta herramienta es educativa y orientativa. La herencia de Bitcoin tiene implicaciones legales y fiscales diferentes segun tu jurisdiccion. Consulta profesionales antes de ejecutar un plan final.
          </div>

          <div class="tool-callout">
            <div class="tool-callout__title">Profundiza en herencia</div>
            <p class="tool-callout__text">
              Revisa primero conceptos y riesgos.
              <a href="../nivel-4/herencia-bitcoin.html">Herencia de Bitcoin -&gt;</a>
              <a href="../nivel-4/guia-herencia.html">Guia paso a paso -&gt;</a>
            </p>
          </div>

          <div class="ad-slot ad-content" id="ad-content-1" aria-hidden="true"></div>
        </article>
      </div>
    </main>
  </div>

  <div data-include="footer"></div>
  <script src="../js/includes.js"></script>
  <script src="../js/nav.js"></script>
  <script src="../js/search.js"></script>

  <script>
  (function () {
    'use strict';

    const PRICE_API = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=eur';

    const CUSTODY_INFO = {
      single: {
        title: 'Single key (una seed phrase)',
        risks: [
          'Punto unico de fallo: perder la seed implica perder acceso.',
          'Si alguien copia la seed, puede mover todo el saldo.',
          'Necesitas instrucciones claras para herederos y respaldo fisico seguro.'
        ]
      },
      'multisig-2-3': {
        title: 'Multisig 2-de-3',
        risks: [
          'Mejor equilibrio entre seguridad y recuperacion.',
          'Documenta donde esta cada clave y como combinarlas.',
          'Disena un flujo de acceso para herederos con pruebas reales.'
        ]
      },
      'multisig-3-5': {
        title: 'Multisig 3-de-5',
        risks: [
          'Alta redundancia y resiliencia si se pierde alguna clave.',
          'Mayor complejidad operativa: documentacion obligatoria.',
          'Recomendable con apoyo profesional para ejecucion hereditaria.'
        ]
      },
      exchange: {
        title: 'Custodia en exchange',
        risks: [
          'No controlas directamente las claves privadas.',
          'Puede haber bloqueos, demoras o friccion administrativa.',
          'Conviene pasar a autocustodia para una herencia mas robusta.'
        ]
      }
    };

    const BASE_CHECKLIST = [
      { id: 'seed_secure', text: 'Seed phrase guardada fuera de internet y en respaldo fisico.' },
      { id: 'seed_tested', text: 'Restauracion probada en entorno controlado.' },
      { id: 'instructions', text: 'Instrucciones escritas y legibles para herederos.' },
      { id: 'software', text: 'Wallet y version documentadas.' }
    ];

    const CUSTODY_CHECKLIST = {
      single: [
        { id: 'single_copy', text: 'Existe mas de una copia fisica protegida.' },
        { id: 'single_access', text: 'Hay protocolo claro para acceso heredado.' }
      ],
      'multisig-2-3': [
        { id: 'm23_map', text: 'Mapa de ubicacion de las 3 claves.' },
        { id: 'm23_steps', text: 'Procedimiento documentado para firmar con 2 claves.' }
      ],
      'multisig-3-5': [
        { id: 'm35_map', text: 'Mapa de ubicacion de las 5 claves.' },
        { id: 'm35_steps', text: 'Procedimiento documentado para firmar con 3 claves.' },
        { id: 'm35_fallback', text: 'Plan de contingencia ante perdida de claves.' }
      ],
      exchange: [
        { id: 'ex_policy', text: 'Proceso de sucesion del exchange revisado.' },
        { id: 'ex_credentials', text: 'Credenciales y 2FA con acceso planificado para herederos.' }
      ]
    };

    const btcHoldingsInput = document.getElementById('btc-holdings');
    const btcValueEur = document.getElementById('btc-value-eur');
    const priceDot = document.getElementById('price-dot');
    const priceTickerText = document.getElementById('price-ticker-text');

    const custodyOptions = document.getElementById('custody-options');
    const custodyInfo = document.getElementById('custody-info');
    const custodyInfoTitle = document.getElementById('custody-info-title');
    const custodyInfoRisks = document.getElementById('custody-info-risks');

    const heirsContainer = document.getElementById('heirs-container');
    const addHeirBtn = document.getElementById('add-heir-btn');
    const percentageTotal = document.getElementById('percentage-total');
    const percentageSum = document.getElementById('percentage-sum');
    const heirResults = document.getElementById('heir-results');
    const heirResultsList = document.getElementById('heir-results-list');

    const checklist = document.getElementById('checklist');
    const exportPlanBtn = document.getElementById('export-plan-btn');

    let btcPrice = null;
    let selectedCustody = null;
    let heirs = [];
    let heirId = 0;

    function formatNumber(num, decimals) {
      if (num === null || Number.isNaN(num)) return '-';
      const value = Number(num).toFixed(decimals);
      const parts = value.split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      return parts.join(',');
    }

    function formatBtc(amount) {
      if (amount === null || Number.isNaN(amount)) return '-';
      const fixed = Number(amount).toFixed(8).replace(/\.?0+$/, '');
      return fixed.replace('.', ',');
    }

    async function fetchBtcPrice() {
      try {
        const response = await fetch(PRICE_API, { cache: 'no-store' });
        if (!response.ok) throw new Error('price_api');
        const data = await response.json();
        btcPrice = data.bitcoin.eur;
        priceTickerText.textContent = `1 BTC = ${formatNumber(btcPrice, 0)} EUR`;
        priceDot.classList.remove('tool-price-ticker__dot--error');
      } catch (_) {
        btcPrice = null;
        priceTickerText.textContent = 'Precio no disponible';
        priceDot.classList.add('tool-price-ticker__dot--error');
      }
      updateBtcValue();
    }

    function updateBtcValue() {
      const btc = parseFloat(btcHoldingsInput.value) || 0;
      if (btc > 0 && btcPrice) {
        btcValueEur.textContent = `${formatNumber(btc * btcPrice, 2)} EUR`;
      } else {
        btcValueEur.textContent = '- EUR';
      }
      updateHeirDistribution();
    }

    function selectCustody(type) {
      selectedCustody = type;
      const options = custodyOptions.querySelectorAll('.custody-option');
      options.forEach((option) => option.classList.toggle('selected', option.dataset.custody === type));

      const info = CUSTODY_INFO[type];
      if (!info) {
        custodyInfo.hidden = true;
        return;
      }

      custodyInfoTitle.textContent = info.title;
      custodyInfoRisks.innerHTML = info.risks.map((risk) => `<li>${risk}</li>`).join('');
      custodyInfo.hidden = false;
      updateChecklist();
    }

    function addHeir(name, percentage) {
      heirId += 1;
      heirs.push({ id: heirId, name: name || '', percentage: percentage || 0 });
      renderHeirs();
    }

    function removeHeir(id) {
      heirs = heirs.filter((heir) => heir.id !== id);
      renderHeirs();
      updateHeirDistribution();
      updateChecklist();
    }

    function updateHeir(id, field, value) {
      const heir = heirs.find((item) => item.id === id);
      if (!heir) return;

      if (field === 'percentage') {
        heir[field] = parseFloat(value) || 0;
      } else {
        heir[field] = value;
      }

      updateHeirDistribution();
      updateChecklist();
    }

    function renderHeirs() {
      heirsContainer.innerHTML = '';

      heirs.forEach((heir) => {
        const row = document.createElement('div');
        row.className = 'heir-row';
        row.innerHTML = `
          <div class="tool-field">
            <label class="tool-label" for="heir-name-${heir.id}">Nombre</label>
            <input type="text" id="heir-name-${heir.id}" class="tool-input heir-name" data-id="${heir.id}" value="${heir.name}" placeholder="Ej: Maria" />
          </div>
          <div class="tool-field">
            <label class="tool-label" for="heir-percentage-${heir.id}">Porcentaje</label>
            <input type="number" id="heir-percentage-${heir.id}" class="tool-input heir-percentage" data-id="${heir.id}" value="${heir.percentage || ''}" min="0" max="100" step="0.01" />
          </div>
          <div class="tool-field">
            <label class="tool-label">Asignacion estimada</label>
            <div class="tool-output heir-btc-output" id="heir-btc-${heir.id}">- BTC</div>
          </div>
          <button type="button" class="tool-btn tool-btn--secondary tool-btn--small heir-row__remove" data-id="${heir.id}">Eliminar</button>
        `;
        heirsContainer.appendChild(row);
      });

      heirsContainer.querySelectorAll('.heir-name').forEach((input) => {
        input.addEventListener('input', (event) => {
          const id = parseInt(event.target.dataset.id, 10);
          updateHeir(id, 'name', event.target.value);
        });
      });

      heirsContainer.querySelectorAll('.heir-percentage').forEach((input) => {
        input.addEventListener('input', (event) => {
          const id = parseInt(event.target.dataset.id, 10);
          updateHeir(id, 'percentage', event.target.value);
        });
      });

      heirsContainer.querySelectorAll('.heir-row__remove').forEach((button) => {
        button.addEventListener('click', (event) => {
          const id = parseInt(event.target.dataset.id, 10);
          removeHeir(id);
        });
      });

      updatePercentageTotal();
    }

    function updatePercentageTotal() {
      const total = heirs.reduce((sum, heir) => sum + (heir.percentage || 0), 0);
      percentageSum.textContent = `${formatNumber(total, 2)}%`;
      percentageTotal.classList.remove('percentage-total--valid', 'percentage-total--invalid');

      if (Math.abs(total - 100) < 0.0001) {
        percentageTotal.classList.add('percentage-total--valid');
      } else if (total > 100) {
        percentageTotal.classList.add('percentage-total--invalid');
      }
    }

    function updateHeirDistribution() {
      const btc = parseFloat(btcHoldingsInput.value) || 0;
      const totalPct = heirs.reduce((sum, heir) => sum + (heir.percentage || 0), 0);
      heirResultsList.innerHTML = '';

      heirs.forEach((heir) => {
        const output = document.getElementById(`heir-btc-${heir.id}`);
        if (!output) return;

        if (btc > 0 && heir.percentage > 0) {
          const amountBtc = (btc * heir.percentage) / 100;
          output.textContent = `${formatBtc(amountBtc)} BTC`;

          if (heir.name.trim()) {
            const valueEur = btcPrice ? amountBtc * btcPrice : null;
            const resultItem = document.createElement('div');
            resultItem.className = 'heir-result-item';
            resultItem.innerHTML = `
              <span class="heir-result-name">${heir.name} (${formatNumber(heir.percentage, 2)}%)</span>
              <span class="heir-result-values">
                <span class="heir-result-btc">${formatBtc(amountBtc)} BTC</span>
                ${valueEur !== null ? `<span class="heir-result-eur">${formatNumber(valueEur, 2)} EUR</span>` : ''}
              </span>
            `;
            heirResultsList.appendChild(resultItem);
          }
        } else {
          output.textContent = '- BTC';
        }
      });

      const hasResults = btc > 0 && totalPct > 0 && heirResultsList.children.length > 0;
      heirResults.hidden = !hasResults;

      updatePercentageTotal();
    }

    function updateChecklist() {
      const items = [...BASE_CHECKLIST];

      if (selectedCustody && CUSTODY_CHECKLIST[selectedCustody]) {
        items.push(...CUSTODY_CHECKLIST[selectedCustody]);
      }

      if (heirs.some((heir) => heir.name.trim())) {
        items.push({ id: 'heirs_notified', text: 'Herederos informados sobre el proceso de acceso.' });
      }

      checklist.innerHTML = '';

      items.forEach((item) => {
        const li = document.createElement('li');
        li.className = 'tool-checklist__item';
        li.innerHTML = `
          <button type="button" class="tool-checklist__checkbox" data-id="${item.id}" aria-pressed="false" aria-label="Marcar item"></button>
          <span class="tool-checklist__text">${item.text}</span>
        `;
        checklist.appendChild(li);
      });

      checklist.querySelectorAll('.tool-checklist__checkbox').forEach((checkbox) => {
        checkbox.addEventListener('click', () => {
          const checked = checkbox.classList.toggle('tool-checklist__checkbox--checked');
          checkbox.setAttribute('aria-pressed', String(checked));
        });
      });
    }

    function exportPlan() {
      const btc = parseFloat(btcHoldingsInput.value) || 0;
      const lines = [];

      lines.push('PLAN DE HERENCIA BITCOIN');
      lines.push('Generado en aprendebtc.com');
      lines.push(`Fecha: ${new Date().toLocaleDateString('es-ES')}`);
      lines.push('');
      lines.push(`Patrimonio: ${formatBtc(btc)} BTC`);
      if (btc > 0 && btcPrice) {
        lines.push(`Valor estimado: ${formatNumber(btc * btcPrice, 2)} EUR`);
      }
      lines.push(`Custodia: ${selectedCustody ? CUSTODY_INFO[selectedCustody].title : 'Sin definir'}`);
      lines.push('');
      lines.push('Distribucion:');

      if (heirs.length === 0) {
        lines.push('- Sin herederos definidos');
      } else {
        heirs.forEach((heir) => {
          if (!heir.name.trim() || heir.percentage <= 0) return;
          const amountBtc = (btc * heir.percentage) / 100;
          lines.push(`- ${heir.name}: ${formatNumber(heir.percentage, 2)}% (${formatBtc(amountBtc)} BTC)`);
        });
      }

      lines.push('');
      lines.push('Checklist actual:');
      checklist.querySelectorAll('.tool-checklist__item').forEach((item) => {
        const checkbox = item.querySelector('.tool-checklist__checkbox');
        const text = item.querySelector('.tool-checklist__text').textContent;
        const checked = checkbox.classList.contains('tool-checklist__checkbox--checked');
        lines.push(`- [${checked ? 'x' : ' '}] ${text}`);
      });

      const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const anchor = document.createElement('a');
      anchor.href = url;
      anchor.download = 'plan-herencia-bitcoin.txt';
      document.body.appendChild(anchor);
      anchor.click();
      document.body.removeChild(anchor);
      URL.revokeObjectURL(url);
    }

    btcHoldingsInput.addEventListener('input', updateBtcValue);

    custodyOptions.addEventListener('click', (event) => {
      const option = event.target.closest('.custody-option');
      if (!option) return;
      selectCustody(option.dataset.custody);
    });

    addHeirBtn.addEventListener('click', () => addHeir('', 0));
    exportPlanBtn.addEventListener('click', exportPlan);

    addHeir('', 0);
    updateChecklist();
    fetchBtcPrice();
  })();
  </script>
</body>
</html>

